# Enable MoonBit Language Server in Neovim

## Context

MoonBit toolchain is installed at `~/.local/share/moonbit/` with the LSP binary at `~/.local/share/moonbit/bin/moonbit-lsp`. The binary is on `$PATH` via Home Manager's `home.sessionPath`. However, Neovim has no built-in support for MoonBit -- no filetype detection, no lspconfig entry, no treesitter grammar.

The challenge: the current nvim config feeds a single server list to both `vim.lsp.enable()` and `mason-lspconfig.ensure_installed`. Since moonbit-lsp is not in the Mason registry, we need to separate these concerns.

## Approach

Split the `ls.lua` server list into `lsp` (all servers, for `vim.lsp.enable()`) and `mason_lsp` (Mason-managed only, for `ensure_installed`). This keeps moonbit-lsp in the standard `after/lsp/` convention while avoiding Mason errors.

## Changes

### 1. Create `config/nvim/after/lsp/moonbit_lsp.lua` (new)

```lua
local moon_home = vim.env.MOON_HOME or (vim.env.HOME .. "/.local/share/moonbit")

return {
  cmd = { moon_home .. "/bin/moonbit-lsp" },
  filetypes = { "moonbit" },
  root_markers = { "moon.mod.json" },
}
```

- Uses `$MOON_HOME` with fallback for robustness (avoids relying on PATH).
- `root_markers = { "moon.mod.json" }` -- the `01_lsp.lua` default `root_dir` logic will use `vim.fs.root()` with these markers, falling back to `.git` if not found.

### 2. Create `config/nvim/filetype.lua` (new)

Register `.mbt` and `.mbti` extensions as `moonbit` filetype:

```lua
vim.filetype.add({
  extension = {
    mbt = "moonbit",
    mbti = "moonbit",
  },
})
```

### 3. Modify `config/nvim/lua/config/ls.lua`

Add `nonMasonServers` set and export `mason_lsp` alongside existing `lsp`:

- Add a `nonMasonServers` table listing `"moonbit_lsp"`
- Add a `get_mason_servers()` helper that filters out non-Mason servers
- Export `mason_lsp` in addition to `lsp` and `tools`

### 4. Modify `config/nvim/lua/plugins/config/williamboman/mason-lspconfig_nvim/init.lua`

Change `ensure_installed` from `require("config.ls").lsp` to `require("config.ls").mason_lsp`.

## Files

| File | Action |
|------|--------|
| `config/nvim/after/lsp/moonbit_lsp.lua` | Create |
| `config/nvim/filetype.lua` | Create |
| `config/nvim/lua/config/ls.lua` | Modify |
| `config/nvim/lua/plugins/config/williamboman/mason-lspconfig_nvim/init.lua` | Modify |

## Verification

1. Open a `.mbt` file -- `:set filetype?` should return `moonbit`
2. Open a `.mbt` file in a directory with `moon.mod.json` -- `:LspInfo` should show `moonbit_lsp` attached
3. `:Mason` should show no warnings about `moonbit_lsp`
4. Existing LSP servers continue working normally

## Notes

- No syntax highlighting for `.mbt` files (no treesitter grammar exists). Can be addressed separately.
- Adding future non-Mason servers only requires appending to `nonMasonServers` in `ls.lua`.
